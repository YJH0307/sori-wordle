<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>소리워들</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;900&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 20px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      min-height: 100vh;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body.light { background: #fff; color: #000; }
    body.dark { background: #121213; color: #eee; }

    h1 { font-size: 48px; font-weight: 900; margin: 10px; }

    .controls { margin: 10px; text-align: center; }
    .controls button {
      font-size: 18px; margin: 0 5px; padding: 8px 14px;
      border: none; border-radius: 6px; cursor: pointer;
    }
    body.light .controls button, body.light #shareBtn { background: #eee; color: #000; }
    body.dark  .controls button, body.dark #shareBtn { background: #ddd; color: #000; }

    .board { display: grid; grid-template-rows: repeat(6, 1fr); gap: 5px; margin: 20px auto; width: max-content; }
    .row { display: grid; gap: 5px; }
    .cell {
      width: 50px; height: 50px; border: 2px solid #ccc;
      display: flex; justify-content: center; align-items: center;
      font-size: 25px; font-weight: bold;
    }
    .correct { background: #6aaa64; color: white; }
    .present { background: #c9b458; color: white; }
    .absent  { background: #787c7e; color: white; }
    body.dark .cell { border-color: #3a3a3c; }
    body.dark .correct { background: #538d4e; }
    body.dark .present { background: #b59f3b; }
    body.dark .absent  { background: #3a3a3c; }

    #shareBtn { display: none; }

    #keyboard { display: grid; grid-template-rows: repeat(3, 1fr); gap: 5px; width: 600px; margin: 20px auto; }
    .key-row { display: flex; justify-content: center; gap: 5px; flex-wrap: wrap; }
    .key {
      padding: 10px 14px; border: 1px solid #ccc; border-radius: 4px;
      cursor: pointer; font-weight: bold; user-select: none;
    }
    body.light .key { background: #ddd; color: #000; }
    body.dark  .key { background: #444; color: #fff; }
    .key.correct { background: #6aaa64; color: #fff; }
    .key.present { background: #c9b458; color: #fff; }
    .key.absent  { background: #3a3a3c; color: #fff; }

    /* 모달 */
    .modal {
      display: none; position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      opacity: 0; transition: opacity 0.4s ease;
      justify-content: center; align-items: center;
    }
    .modal.show { display: flex; opacity: 1; }
    .modal-content {
      background: white; color: black;
      border-radius: 10px; padding: 20px;
      width: 320px; text-align: center;
      transform: scale(0.8); transition: transform 0.3s ease;
      position: relative;
    }
    .modal.show .modal-content { transform: scale(1); }
    .modal-content.dark { background: #2a2a2b; color: #ddd; }
    .close {
      position: absolute; top: 10px; right: 15px;
      font-size: 22px; font-weight: bold; cursor: pointer;
    }
    #histogram .bar {
      background: #6aaa64; height: 20px; margin: 3px 0; color: white;
      display: inline-block; text-align: right; padding-right: 5px;
    }

    /* 숨김 input (IME 입력용) */
    #imeInput {
      position: absolute; opacity: 0; pointer-events: none;
      width: 0; height: 0;
    }
  </style>
</head>
<body class="light">
  <h1>소리워들</h1>
  <div class="controls">
    <button onclick="openStats()">통계 보기</button>
    <button id="themeBtn" onclick="toggleTheme()">🌙 다크 모드</button>
  </div>

  <div class="board" id="board"></div>

  <div class="controls">
    <button id="shareBtn" onclick="shareResult()">공유하기</button>
  </div>

  <div id="keyboard"></div>

  <!-- IME 입력용 숨김 input -->
  <input id="imeInput" autocomplete="off" autocapitalize="off" spellcheck="false" />

  <!-- 통계 모달 -->
  <div id="statsModal" class="modal">
    <div id="modalContent" class="modal-content">
      <span class="close" onclick="closeStats()">&times;</span>
      <h2>📊 통계</h2>
      <p id="statsText"></p>
      <h3>시도 분포</h3>
      <div id="histogram"></div>
    </div>
  </div>

  <script>
    // === 테마 ===
    function loadTheme() {
      const t = localStorage.getItem('sori-wordle-theme') || 'light';
      document.body.className = t;
      document.getElementById('themeBtn').textContent =
        t === 'light' ? '🌙 다크 모드' : '☀️ 라이트 모드';
    }
    function toggleTheme() {
      const cur = document.body.className === 'light' ? 'dark' : 'light';
      document.body.className = cur;
      localStorage.setItem('sori-wordle-theme', cur);
      loadTheme();
    }
    loadTheme();

    // === 한글 분리 ===
    const 초성=["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
    const 중성=["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅘ","ㅙ","ㅚ","ㅛ","ㅜ","ㅝ","ㅞ","ㅟ","ㅠ","ㅡ","ㅢ","ㅣ"];
    const 종성=["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
    const 꼬들이중모음={"ㅘ":["ㅗ","ㅏ"],"ㅙ":["ㅗ","ㅐ"],"ㅚ":["ㅗ","ㅣ"],"ㅝ":["ㅜ","ㅓ"],"ㅞ":["ㅜ","ㅔ"],"ㅟ":["ㅜ","ㅣ"],"ㅢ":["ㅡ","ㅣ"]};
    function 분리(ch){
      const code=ch.charCodeAt(0)-0xAC00;
      if(code<0||code>11171)return[ch];
      const cho=Math.floor(code/588);
      const jung=Math.floor((code-cho*588)/28);
      const jong=code%28;
      let res=[초성[cho]];
      const jungChar=중성[jung];
      if(꼬들이중모음[jungChar])res.push(...꼬들이중모음[jungChar]); else res.push(jungChar);
      if(jong!==0)res.push(종성[jong]);
      return res;
    }

    // === Google Sheets CSV ===
    const sheetUrl="https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4cPYQbKRxFQsTv7byzVnKwN6WdlRECyFvSkn39mcnNIywqTZ9W71P8nzw0SI8oEP_4QzBFaJbNQyN/pub?output=csv";
    let 단어목록=[];
    fetch(sheetUrl+"&t="+Date.now()).then(r=>r.text()).then(csv=>{
      단어목록=csv.split("\n").map(s=>s.trim()).filter(Boolean);
      initGame();
    });

    // === 게임 ===
    let 정답,정답낱자,maxRows=6,board;
    let currentRow=0,currentCol=0,gameOver=false;
    let rowsData=[],currentGuess=[];

    function initGame(){
      const start=new Date(2025,0,1),today=new Date();
      const days=Math.floor((today-start)/(1000*60*60*24));
      정답=단어목록[days%단어목록.length];
      정답낱자=[]; for(let ch of 정답)정답낱자.push(...분리(ch));

      board=document.getElementById("board");
      board.innerHTML="";
      for(let r=0;r<maxRows;r++){
        const row=document.createElement("div"); row.className="row";
        row.style.gridTemplateColumns=`repeat(${정답낱자.length},50px)`;
        for(let c=0;c<정답낱자.length;c++){
          const cell=document.createElement("div"); cell.className="cell";
          row.appendChild(cell);
        }
        board.appendChild(row);
      }

      buildKeyboard();
    }

    function buildKeyboard(){
      const keyboardRows=[
        ["ㅂ","ㅈ","ㄷ","ㄱ","ㅅ","ㅛ","ㅕ","ㅑ","ㅐ","ㅔ"],
        ["ㅁ","ㄴ","ㅇ","ㄹ","ㅎ","ㅗ","ㅓ","ㅏ","ㅣ"],
        ["Enter","ㅋ","ㅌ","ㅊ","ㅍ","ㅠ","ㅜ","ㅡ","←"]
      ];
      const keyDiv=document.getElementById("keyboard"); keyDiv.innerHTML="";
      keyboardRows.forEach(rowKeys=>{
        const rowDiv=document.createElement("div"); rowDiv.className="key-row";
        rowKeys.forEach(k=>{
          const keyBtn=document.createElement("div");
          keyBtn.className="key"; keyBtn.textContent=k;
          keyBtn.onclick=()=>handleKey(k);
          rowDiv.appendChild(keyBtn);
        });
        keyDiv.appendChild(rowDiv);
      });
    }

    function handleKey(k){
      if(gameOver)return;
      if(k==="Enter"){
        if(currentCol===정답낱자.length)submitGuess();
      } else if(k==="←"){
        if(currentCol>0){
          currentCol--; currentGuess.pop();
          board.children[currentRow].children[currentCol].textContent="";
        }
      } else {
        if(currentCol<정답낱자.length){
          currentGuess.push(k);
          board.children[currentRow].children[currentCol].textContent=k;
          currentCol++;
        }
      }
    }

// ---- IME 입력: 낱자 단위 즉시 반영 ----
const ime = document.getElementById('imeInput');
function focusIME(){ ime.focus(); }
window.addEventListener('load', focusIME);
document.addEventListener('click', focusIME);

// 조합 이벤트는 무시
ime.addEventListener('compositionstart', () => {});
ime.addEventListener('compositionupdate', () => {});
ime.addEventListener('compositionend', () => {});

// input 이벤트가 들어올 때마다 낱자 처리
ime.addEventListener('input', (e) => {
  const text = ime.value;
  ime.value = ''; // 매번 비워서 중복 방지
  if (!text) return;

  for (const ch of text) {
    if (/^[ㄱ-ㅎㅏ-ㅣ]$/.test(ch)) {
      handleKey(ch);  // 자모 그대로
    } else if (/^[가-힣]$/.test(ch)) {
      const parts = 분리(ch);  // 완성형은 분리
      for (const j of parts) handleKey(j);
    }
  }
});

// Enter / Backspace는 keydown으로 처리
document.addEventListener("keydown", (e) => {
  if (gameOver) return;
  if (e.key === "Enter") handleKey("Enter");
  if (e.key === "Backspace") handleKey("←");
});
    document.addEventListener("keydown",e=>{
      if(gameOver)return;
      if(e.key==="Enter")handleKey("Enter");
      if(e.key==="Backspace")handleKey("←");
    });

    function submitGuess(){
      const guess낱자=[...currentGuess];
      const row=board.children[currentRow].children;
      const rowData=[];
      for(let i=0;i<정답낱자.length;i++){
        const gc=guess낱자[i]; row[i].textContent=gc;
        let state="absent";
        if(gc===정답낱자[i])state="correct";
        else if(정답낱자.includes(gc))state="present";
        row[i].classList.add(state);
        rowData.push({letter:gc,state});
        updateKeyboard(gc,state);
      }
      rowsData[currentRow]=rowData;

      if(guess낱자.join("")===정답낱자.join("")){
        setTimeout(()=>alert("정답! 🎉"),100);
        gameOver=true; document.getElementById("shareBtn").style.display="inline-block";
        updateStats(true,currentRow+1); // ✅ 시도 횟수 정확히 반영
      }
      currentRow++; currentCol=0; currentGuess=[];
      if(currentRow>=maxRows&&!gameOver){
        setTimeout(()=>alert(`실패! 정답은 ${정답}`),100);
        gameOver=true; document.getElementById("shareBtn").style.display="inline-block";
        updateStats(false);
      }
    }

    function updateKeyboard(letter,state){
      document.querySelectorAll(".key").forEach(k=>{
        if(k.textContent===letter){
          if(state==="correct")k.className="key correct";
          else if(state==="present"&&!k.classList.contains("correct"))k.className="key present";
          else if(state==="absent"&&!k.classList.contains("correct")&&!k.classList.contains("present"))k.className="key absent";
        }
      });
    }

    function shareResult(){
      const todayKey=new Date().toISOString().split("T")[0];
      let txt=`소리워들 ${todayKey}\n`;
      txt+=gameOver?`${currentRow}/${maxRows}\n\n`:`실패\n\n`;
      rowsData.forEach(row=>{
        row.forEach(c=>{
          txt+=c.state==="correct"?"🟩":c.state==="present"?"🟨":"⬛";
        }); txt+="\n";
      });
      navigator.clipboard.writeText(txt).then(()=>alert("결과가 복사되었습니다!"));
    }

    function updateStats(success,tries){
      const key="sori-wordle-stats";
      const st=JSON.parse(localStorage.getItem(key))||{games:0,wins:0,losses:0,streak:0,maxStreak:0,distribution:{}};
      st.games++;
      if(success){
        st.wins++; st.streak++; if(st.streak>st.maxStreak)st.maxStreak=st.streak;
        st.distribution[tries]=(st.distribution[tries]||0)+1;
      } else { st.losses++; st.streak=0; }
      localStorage.setItem(key,JSON.stringify(st));
      setTimeout(()=>showStats(st),600);
    }

    function showStats(st){
      const modal=document.getElementById("statsModal");
      const mc=document.getElementById("modalContent");
      mc.className="modal-content "+document.body.className;
      document.getElementById("statsText").innerHTML=
        `총 게임: ${st.games}<br>승리: ${st.wins} / 패배: ${st.losses}<br>`+
        `성공률: ${(st.games?(st.wins/st.games*100).toFixed(1):0)}%<br>`+
        `연속 성공: ${st.streak}<br>최고 연속: ${st.maxStreak}`;
      const hist=document.getElementById("histogram"); hist.innerHTML="";
      for(let i=1;i<=6;i++){
        const cnt=st.distribution[i]||0;
        hist.innerHTML+=`${i}회: <div class="bar" style="width:${cnt*20+20}px">${cnt||''}</div><br>`;
      }
      modal.style.display="flex"; setTimeout(()=>modal.classList.add("show"),20);
    }
    function closeStats(){
      const modal=document.getElementById("statsModal");
      modal.classList.remove("show");
      setTimeout(()=>{modal.style.display="none";},400);
    }
    function openStats(){
      const st=JSON.parse(localStorage.getItem("sori-wordle-stats"))||{games:0,wins:0,losses:0,streak:0,maxStreak:0,distribution:{}};
      showStats(st);
    }
  </script>
</body>
</html>
