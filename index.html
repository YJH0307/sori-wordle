<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>소리워들</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;900&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 20px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      min-height: 100vh;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body.light { background: #fff; color: #000; }
    body.dark { background: #121213; color: #eee; }

    h1 { font-size: 40px; font-weight: 900; margin: 10px; }

    .controls { margin: 10px; text-align: center; }
    .controls button {
      font-size: 16px; margin: 0 5px; padding: 8px 14px;
      border: none; border-radius: 6px; cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif; font-weight: 700;
    }
    body.light .controls button, body.light #shareBtn { background: #eee; color: #000; }
    body.dark  .controls button, body.dark #shareBtn { background: #ddd; color: #000; }

    .board {
  display: grid;
  grid-template-rows: repeat(6, 1fr);
  gap: 5px;
  margin: 20px auto;
  width: 100%;               /* ← 기존 max-content 대신 전체 폭 */
  justify-items: center;     /* ← 추가: 각 행을 가로 중앙에 배치 */
    }
    .row {
  display: grid;
  gap: 3px;
  justify-content: center;   /* ← 추가: 열 트랙 중앙 정렬 */
    }
   .cell {
  width: 45px; height: 45px; border: 2px solid #ccc;
  display: flex; justify-content: center; align-items: center;
  font-size: 22px; font-weight: bold;
  font-family: 'Noto Sans KR', sans-serif;
  border-radius: 6px;   /* ✅ 모서리를 둥글게 */
}
    .correct { background: #6aaa64; color: white; }
    .present { background: #c9b458; color: white; }
    .absent  { background: #787c7e; color: white; }
    body.dark .cell { border-color: #3a3a3c; }
    body.dark .correct { background: #538d4e; }
    body.dark .present { background: #b59f3b; }
    body.dark .absent  { background: #3a3a3c; }

    #shareBtn { display: none; }

    /* === 키보드 === */
    #keyboard {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 20px auto;
      align-items: center;
      width: 100%;
      max-width: 500px;
    }
    .key-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      width: 100%;
    }
    .key {
      flex: 1;
      aspect-ratio: 1/1;
      font-size: 18px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
      background: #ddd;
      display: flex; justify-content: center; align-items: center;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .key.correct { background: #6aaa64 !important; color: #fff !important; }
    .key.present { background: #c9b458 !important; color: #fff !important; }
    .key.absent  { background: #787c7e !important; color: #fff !important; }

    body.light .key { background: #ddd; color: #000; }
    body.dark  .key { background: #444; color: #fff; }

    .key.wide { flex: 1.5; }

    /* 팝업 */
    .popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex;
      justify-content: center; align-items: center;
    }
    .popup.hidden { display: none; }
    .popup-content {
      background: white; padding: 20px; border-radius: 8px;
      text-align: center; max-width: 320px; width: 80%;
      animation: fadeIn 0.6s ease;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .popup-content h2 { margin-top: 0; font-weight: 900; }
    #popup-close { float: right; cursor: pointer; font-size: 20px; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

    /* 모바일 */
    @media (max-width: 480px) {
      .cell { width: 34px; height: 34px; font-size: 18px; }
      .key { font-size: 15px; }
    }
  </style>
</head>
<body class="light">
  <h1>소리워들</h1>
  <div class="controls">
    <button id="statsBtn">통계 보기</button>
    <button id="themeBtn" onclick="toggleTheme()">🌙 다크 모드</button>
  </div>

  <div class="board" id="board"></div>

  <div class="controls">
    <button id="shareBtn" onclick="shareResult()">공유하기</button>
  </div>

  <div id="keyboard"></div>

  <!-- 팝업 -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <span id="popup-close">×</span>
      <h2>오늘의 소리워들</h2>
      <p id="popup-message"></p>
    </div>
  </div>

<div id="helpPopup" class="popup hidden">
  <div class="popup-content">
    <span id="help-close" style="float:right;cursor:pointer;font-size:20px;">×</span>
    <h2>게임 규칙</h2>
    <div style="text-align:center;line-height:1.8;font-size:15px;">
      <div style="font-size:20px;font-weight:900;margin-bottom:8px;">소리워들</div>
      <div>소리MAD와 관련된 모든 단어가 제시어입니다.</div>
      <div>하루에 문제 1개, 기회 6번.</div>
      <div style="margin-top:8px;">색의 의미</div>
      <div>🟩 위치·낱자 모두 일치</div>
      <div>🟨 단어 안에 있지만 위치 다름</div>
      <div>⬜ 단어에 없음</div>
      <div style="font-size:12px;color:#888;margin-top:10px;">“소리워들”은 자정에 갱신됩니다.</div>
    </div>
  </div>
</div>
  
  <script>

      // === 규칙 팝업 ===
  function openHelpPopup(){
    document.getElementById("helpPopup").classList.remove("hidden");
  }
  function closeHelpPopup(){
    document.getElementById("helpPopup").classList.add("hidden");
  }
  document.getElementById("help-close").onclick = closeHelpPopup;

  // 당일 첫 접속 시 규칙 팝업 자동 표시
  const todayKey = "help-seen-" + new Date().toISOString().slice(0,10);
  if(!localStorage.getItem(todayKey)){
    setTimeout(openHelpPopup, 500);
    localStorage.setItem(todayKey,"true");
  }

    // === 테마 ===
    function loadTheme() {
      const t = localStorage.getItem('sori-wordle-theme') || 'light';
      document.body.className = t;
      document.getElementById('themeBtn').textContent =
        t === 'light' ? '🌙 다크 모드' : '☀️ 라이트 모드';
    }
    function toggleTheme() {
      const cur = document.body.className === 'light' ? 'dark' : 'light';
      document.body.className = cur;
      localStorage.setItem('sori-wordle-theme', cur);
      loadTheme();
    }
    loadTheme();

    // === 한글 분리 ===
    const 초성=["ㄱ","ㄲ","ㄴ","ㄷ","ㄸ","ㄹ","ㅁ","ㅂ","ㅃ","ㅅ","ㅆ","ㅇ","ㅈ","ㅉ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
    const 중성=["ㅏ","ㅐ","ㅑ","ㅒ","ㅓ","ㅔ","ㅕ","ㅖ","ㅗ","ㅘ","ㅙ","ㅚ","ㅛ","ㅜ","ㅝ","ㅞ","ㅟ","ㅠ","ㅡ","ㅢ","ㅣ"];
    const 종성=["","ㄱ","ㄲ","ㄳ","ㄴ","ㄵ","ㄶ","ㄷ","ㄹ","ㄺ","ㄻ","ㄼ","ㄽ","ㄾ","ㄿ","ㅀ","ㅁ","ㅂ","ㅄ","ㅅ","ㅆ","ㅇ","ㅈ","ㅊ","ㅋ","ㅌ","ㅍ","ㅎ"];
    const 꼬들이중모음={ "ㅘ":["ㅗ","ㅏ"],"ㅙ":["ㅗ","ㅐ"],"ㅚ":["ㅗ","ㅣ"],"ㅝ":["ㅜ","ㅓ"],"ㅞ":["ㅜ","ㅔ"],"ㅟ":["ㅜ","ㅣ"],"ㅢ":["ㅡ","ㅣ"],"ㅒ":["ㅑ","ㅣ"],"ㅖ":["ㅕ","ㅣ"] };
    const 꼬들이중받침={ "ㄳ":["ㄱ","ㅅ"],"ㄵ":["ㄴ","ㅈ"],"ㄶ":["ㄴ","ㅎ"],"ㄺ":["ㄹ","ㄱ"],"ㄻ":["ㄹ","ㅁ"],"ㄼ":["ㄹ","ㅂ"],"ㄽ":["ㄹ","ㅅ"],"ㄾ":["ㄹ","ㅌ"],"ㄿ":["ㄹ","ㅍ"],"ㅀ":["ㄹ","ㅎ"],"ㅄ":["ㅂ","ㅅ"] };
    const 꼬들된소리 = {"ㄲ":["ㄱ","ㄱ"], "ㄸ":["ㄷ","ㄷ"], "ㅃ":["ㅂ","ㅂ"], "ㅉ":["ㅈ","ㅈ"], "ㅆ":["ㅅ","ㅅ"]
};

    function 분리(ch){
  const code=ch.charCodeAt(0)-0xAC00;
  if(code<0||code>11171) return [ch];

  const cho=Math.floor(code/588), jung=Math.floor((code-cho*588)/28), jong=code%28;
  let res=[];

  // 초성 처리: 된소리면 분해
  const choChar=초성[cho];
  if(꼬들된소리[choChar]) res.push(...꼬들된소리[choChar]);
  else res.push(choChar);

  // 중성 처리: 이중모음 분해
  const jungChar=중성[jung];
  if(꼬들이중모음[jungChar]) res.push(...꼬들이중모음[jungChar]);
  else res.push(jungChar);

  // 종성 처리: 이중받침/된소리 분해
  if(jong!==0){
    const jongChar=종성[jong];
    if(꼬들이중받침[jongChar]) res.push(...꼬들이중받침[jongChar]);
    else if(꼬들된소리[jongChar]) res.push(...꼬들된소리[jongChar]);  // ㄲ, ㅆ 처리
    else res.push(jongChar);
  }

  return res;
}


// === 데이터 ===
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4cPYQbKRxFQsTv7byzVnKwN6WdlRECyFvSkn39mcnNIywqTZ9W71P8nzw0SI8oEP_4QzBFaJbNQyN/pub?output=csv";
let 단어목록 = [];
const fallbackWords = ["날왈","사이키라", "대정령", "렌더", "우사테이"];

// 🔴 전역 상태 (누락되어 있던 것들)
let 정답, 정답낱자;
const maxRows = 6;
let currentRow = 0, currentCol = 0;
let gameOver = false;
let currentGuess = [];
let lastTries = null;   // ✅ 추가: 공유용 시도 횟수 저장

// CSV 1열만 사용 + BOM/CRLF 정리
function parseCSVFirstColumn(csvText){
  const clean = csvText.replace(/^\uFEFF/, "");
  const lines = clean.split(/\r?\n/);
  const firstCol = lines
    .map(line => (line.split(",")[0] || "").trim())
    .filter(Boolean);
  // 순수 한글만
  const onlyHangul = firstCol.filter(w => /^[가-힣]+$/.test(w));
  return onlyHangul;
}

// 시트 로딩 (중복 호출 금지)
function loadWords(){
  return fetch(sheetUrl + "&t=" + Date.now(), { cache: "no-store" })
    .then(r => {
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    })
    .then(csv => {
      // 디버그 로그 (개발자도구 콘솔에서 확인)
      console.log("[CSV raw len]", csv.length);
      console.log("[CSV preview]", csv.slice(0, 200));

      const parsed = parseCSVFirstColumn(csv);
      console.log("[Parsed count]", parsed.length, parsed.slice(0, 10));

      if (parsed.length === 0) throw new Error("빈 목록");
      return parsed;
    });
}

// ✅ 호출부: 반드시 한 번만!
loadWords()
  .then(list => { 단어목록 = list; initGame(); })
  .catch(err => {
    console.error("단어 목록 로드 실패:", err);
    단어목록 = fallbackWords;
    showPopup("단어 목록을 불러오지 못했습니다. 시트를 '웹에 게시'했는지와 A열에 한글만 있는지 확인하세요.");
    initGame();
  });

    // === 통계 ===
    function updateStats(win, tries){
      const stats=JSON.parse(localStorage.getItem("sori-stats")||'{"played":0,"wins":0,"dist":[0,0,0,0,0,0]}');
      stats.played++;
      if(win){ stats.wins++; stats.dist[tries-1]++; }
      localStorage.setItem("sori-stats", JSON.stringify(stats));
    }
    function getStats(){
      return JSON.parse(localStorage.getItem("sori-stats")||'{"played":0,"wins":0,"dist":[0,0,0,0,0,0]}');
    }

    // === 게임 초기화 ===

  function initGame(){
  const start = new Date(2025,0,1), today = new Date();
  const days  = Math.floor((today-start)/(1000*60*60*24));

  // 1) 정답 선택(단어목록이 비어도 폴백 보장)
  const pool = (Array.isArray(단어목록) && 단어목록.length>0) ? 단어목록 : fallbackWords;
  정답 = pool[days % pool.length] || fallbackWords[0];

  // 2) 낱자 분해 + 최종 안전장치
  정답낱자 = [];
  for (let ch of 정답) 정답낱자.push(...분리(ch));
  if (!정답낱자.length) {              // 만약 분해가 비정상이라면
    정답 = fallbackWords[0];
    정답낱자 = [];
    for (let ch of 정답) 정답낱자.push(...분리(ch));
  }

  // 3) 보드 렌더
  const board = document.getElementById("board");
  board.innerHTML = "";
  for (let r=0; r<maxRows; r++){
    const row = document.createElement("div");
    row.className = "row";
    row.style.gridTemplateColumns = `repeat(${정답낱자.length}, 45px)`;
    for (let c=0; c<정답낱자.length; c++){
      const cell = document.createElement("div");
      cell.className = "cell";
      row.appendChild(cell);
    }
    board.appendChild(row);
  }

  buildKeyboard();
  console.log("[INIT] answer:", 정답, "/ letters:", 정답낱자.length); // 디버깅 로그
    }


    // === 키보드 ===
    function buildKeyboard(){
      const rows=[["ㅂ","ㅈ","ㄷ","ㄱ","ㅅ","ㅛ","ㅕ","ㅑ","ㅐ","ㅔ"],
                  ["ㅁ","ㄴ","ㅇ","ㄹ","ㅎ","ㅗ","ㅓ","ㅏ","ㅣ"],
                  ["입력","ㅋ","ㅌ","ㅊ","ㅍ","ㅠ","ㅜ","ㅡ","삭제"]];
      const keyDiv=document.getElementById("keyboard"); keyDiv.innerHTML="";
      rows.forEach(row=>{
        const rowDiv=document.createElement("div"); rowDiv.className="key-row";
        row.forEach(k=>{
          const keyBtn=document.createElement("div");
          keyBtn.className="key"; keyBtn.textContent=k;
          if(k==="입력"||k==="삭제") keyBtn.classList.add("wide");
          keyBtn.onclick=()=>handleKey(k);
          rowDiv.appendChild(keyBtn);
        });
        keyDiv.appendChild(rowDiv);
      });
    }

    // === 키 입력 ===
    function handleKey(k){
      if(gameOver) return;
      if(k==="입력"){ if(currentCol===정답낱자.length) submitGuess(); }
      else if(k==="삭제"){
        if(currentCol>0){ currentCol--; currentGuess.pop();
          document.getElementById("board").children[currentRow].children[currentCol].textContent=""; }
      } else {
        if(currentCol<정답낱자.length){
          currentGuess.push(k);
          document.getElementById("board").children[currentRow].children[currentCol].textContent=k;
          currentCol++;
        }
      }
    }

    // === 제출 ===
    function submitGuess(){
  const guess=[...currentGuess];
  if(guess.length!==정답낱자.length) return;

  const row=document.getElementById("board").children[currentRow].children;

  // --- 판정 준비 ---
  const freq={};
  for(let i=0;i<정답낱자.length;i++){
    freq[정답낱자[i]]=(freq[정답낱자[i]]||0)+1;
  }

  const result=new Array(정답낱자.length).fill("absent");
  for(let i=0;i<정답낱자.length;i++){
    if(guess[i]===정답낱자[i]){
      result[i]="correct";
      freq[guess[i]]--;
    }
  }
  for(let i=0;i<정답낱자.length;i++){
    if(result[i]==="correct") continue;
    if(freq[guess[i]]>0){
      result[i]="present";
      freq[guess[i]]--;
    }
  }

  // --- 칸 색칠 + 키보드 갱신 ---
  for(let i=0;i<정답낱자.length;i++){
    row[i].textContent=guess[i];
    row[i].classList.add(result[i]);
    updateKeyboard(guess[i],result[i]);
  }

  // --- 정답 맞춘 경우 ---
  if(guess.join("")===정답낱자.join("")){
    gameOver=true;
    const tries = currentRow+1;   // ✅ 실제 시도 횟수(오프바이원 방지)
    lastTries = currentRow+1;   // ✅ 성공한 경우 몇 번째 시도인지 저장
    updateStats(true, tries);
    setTimeout(()=>showPopup("정답! 🎉 ("+tries+"/6)"),600);
    document.getElementById("shareBtn").style.display="inline-block";
    return; // ✅ currentRow++ 방지 (여기서 종료)
  }

  // --- 다음 줄 이동 ---

  currentRow++;
  currentCol=0;
  currentGuess=[];

  // --- 실패 처리 ---
  if(currentRow>=maxRows && !gameOver){
    gameOver=true;
    lastTries = "X";   // ✅ 실패한 경우 X로 저장
    updateStats(false,0);
    setTimeout(()=>showPopup("실패! 정답은 "+정답),600);
    document.getElementById("shareBtn").style.display="inline-block";
  }
}

    // === 키보드 색 업데이트 ===
    function updateKeyboard(letter,state){
      document.querySelectorAll(".key").forEach(k=>{
        if(k.textContent===letter){
          if(state==="correct") k.className="key correct";
          else if(state==="present" && !k.classList.contains("correct")) k.className="key present";
          else if(state==="absent" && !k.classList.contains("correct") && !k.classList.contains("present")) k.className="key absent";
        }
      });
    }

    // === 팝업 ===
    function showPopup(msg){ document.getElementById("popup-message").textContent=msg; document.getElementById("popup").classList.remove("hidden"); }
    document.getElementById("popup-close").onclick=()=>{ document.getElementById("popup").classList.add("hidden"); };

    // === 공유 ===
function shareResult() {
  const text = buildShareText();

  // ✅ 항상 클립보드 복사만 시도
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => alert("결과가 클립보드에 복사되었습니다!"))
      .catch(err => {
        console.error("Clipboard API 실패:", err);
        tryClipboardCopy(text); // 폴백
      });
  } else {
    // ✅ execCommand 폴백
    tryClipboardCopy(text);
  }
}
// ✅ 최종 폴백: 숨은 textarea를 만들어 execCommand('copy') 사용

    function tryClipboardCopy(text){
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.setAttribute("readonly", "");
  ta.style.position = "fixed";
  ta.style.top = "-1000px";
  document.body.appendChild(ta);

  // ▼ 반드시 선택해줘야 복사가 된다
  ta.select();
  ta.setSelectionRange(0, 999999);

  let ok = false;
  try {
    ok = document.execCommand("copy");
  } catch(e) { ok = false; }

  document.body.removeChild(ta);
  alert(ok ? "결과가 클립보드에 복사되었습니다!" : "복사에 실패했습니다. 브라우저/HTTPS 환경을 확인하세요.");
}

// ✅ 공유 텍스트 생성 (N/6 또는 X/6 + 블록 패턴)
function buildShareText(){
  const tries = (lastTries===null) ? "X" : lastTries;

  // ✅ 오늘 날짜 (YYYY-MM-DD)
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  const dateStr = `${yyyy}-${mm}-${dd}`;

  // ✅ 첫 줄에 날짜 포함
  let output = `소리워들 ${tries}/6 (${dateStr})\n`;

  // 성공이면 lastTries 만큼 줄 출력, 실패면 6줄
  const rowsToPrint = (typeof lastTries === "number") ? lastTries : maxRows;

  for (let r=0; r<rowsToPrint; r++){
    // ✅ 마지막 줄이고 성공한 경우 → 전부 초록으로 강제
    if (typeof lastTries === "number" && r === rowsToPrint-1){
      output += "🟩".repeat(정답낱자.length) + "\n";
      continue;
    }

    const row = document.getElementById("board").children[r].children;
    for (let c=0; c<정답낱자.length; c++){
      if (row[c].classList.contains("correct")) output += "🟩";
      else if (row[c].classList.contains("present")) output += "🟨";
      else output += "⬜";
    }
    output += "\n";
  }

  // ✅ 마지막에 사이트 주소 추가
  output += "\nhttps://sori-wordle.com";

  return output;
}
    // === 통계 보기 ===
    document.getElementById("statsBtn").onclick=()=>{
      const s=getStats();
      let msg=`플레이: ${s.played}\n승리: ${s.wins}\n승률: ${s.played?Math.round(s.wins/s.played*100):0}%\n\n시도 분포:\n`;
      s.dist.forEach((v,i)=>{ msg+=`${i+1}회: ${v}\n`; });
      showPopup(msg);
    };
  </script>
</body>
</html>
