<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì†Œë¦¬ì›Œë“¤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@700;900&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0; padding: 20px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      min-height: 100vh;
      font-family: 'Noto Sans KR', sans-serif;
    }
    body.light { background: #fff; color: #000; }
    body.dark { background: #121213; color: #eee; }

    h1 { font-size: 40px; font-weight: 900; margin: 10px; }

    .controls { margin: 10px; text-align: center; }
    .controls button {
      font-size: 16px; margin: 0 5px; padding: 8px 14px;
      border: none; border-radius: 6px; cursor: pointer;
      font-family: 'Noto Sans KR', sans-serif; font-weight: 700;
    }
    body.light .controls button, body.light #shareBtn { background: #eee; color: #000; }
    body.dark  .controls button, body.dark #shareBtn { background: #ddd; color: #000; }

.board {
  display: grid;
  grid-template-rows: repeat(6, 1fr);
  gap: 4px;                   /* â† ì¤„ ê°„ê²© í†µì¼ */
  margin: 20px auto;
  width: 100%;
  justify-items: center;       /* ê° í–‰ì„ ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
}

.row {
  display: flex;
  gap: 4px;                   /* â† ì¹¸ ê°„ê²© í†µì¼ */
  justify-content: center;    /* ì¹¸ë“¤ì„ í•­ìƒ ì¤‘ì•™ì— ë°°ì¹˜ */
}

.cell {
  width: 45px;
  height: 45px;
  border: 2px solid #ccc;
  display: flex;
  justify-content: center;
  align-items: center;
  font-size: 22px;
  font-weight: bold;
  font-family: 'Noto Sans KR', sans-serif;
  border-radius: 6px;
}
.cell.invalid {
  background: rgba(255, 0, 0, 0.2); /* ì—°í•œ ë¹¨ê°„ìƒ‰ ë°°ê²½ */
  border-color: red;
}

    
/* === ëª¨ë°”ì¼ (480px ì´í•˜) === */
@media (max-width: 480px) {
  .board {
    gap: 4px;     /* ëª¨ë°”ì¼ì—ì„œë„ ë™ì¼í•˜ê²Œ ìœ ì§€ */
  }
  .row {
    gap: 4px;
  }
  .cell {
    width: 34px;
    height: 34px;
    font-size: 18px;
  }
}
    .correct { background: #6aaa64; color: white; }
    .present { background: #c9b458; color: white; }
    .absent  { background: #787c7e; color: white; }
    body.dark .cell { border-color: #3a3a3c; }
    body.dark .correct { background: #538d4e; }
    body.dark .present { background: #b59f3b; }
    body.dark .absent  { background: #3a3a3c; }

    #shareBtn { display: none; }

    /* === í‚¤ë³´ë“œ === */
    #keyboard {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 20px auto;
      align-items: center;
      width: 100%;
      max-width: 500px;
    }
    .key-row {
      display: flex;
      justify-content: center;
      gap: 6px;
      width: 100%;
    }
    .key {
      flex: 1;
      aspect-ratio: 1/1;
      font-size: 18px;
      text-align: center;
      border: 1px solid #ccc;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      user-select: none;
      background: #ddd;
      display: flex; justify-content: center; align-items: center;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .key.correct { background: #6aaa64 !important; color: #fff !important; }
    .key.present { background: #c9b458 !important; color: #fff !important; }
    .key.absent  { background: #787c7e !important; color: #fff !important; }

    body.light .key { background: #ddd; color: #000; }
    body.dark  .key { background: #444; color: #fff; }

    .key.wide { flex: 1.5; }

    /* íŒì—… */
    .popup {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); display: flex;
      justify-content: center; align-items: center;
    }
    .popup.hidden { display: none; }
    .popup-content {
      background: white; padding: 20px; border-radius: 8px;
      text-align: center; max-width: 320px; width: 80%;
      animation: fadeIn 0.6s ease;
      font-family: 'Noto Sans KR', sans-serif;
    }
    .popup-content h2 { margin-top: 0; font-weight: 900; }
    #popup-close { float: right; cursor: pointer; font-size: 20px; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }

  </style>
</head>
<body class="light">
  <h1>ì†Œë¦¬ì›Œë“¤</h1>
  <div class="controls">
    <button id="statsBtn">í†µê³„ ë³´ê¸°</button>
    <button id="themeBtn" onclick="toggleTheme()">ğŸŒ™ ë‹¤í¬ ëª¨ë“œ</button>
  </div>

  <div class="board" id="board"></div>

  <div class="controls">
    <button id="shareBtn" onclick="shareResult()">ê³µìœ í•˜ê¸°</button>
  </div>

  <div id="keyboard"></div>

  <!-- íŒì—… -->
  <div id="popup" class="popup hidden">
    <div class="popup-content">
      <span id="popup-close">Ã—</span>
      <h2>ì˜¤ëŠ˜ì˜ ì†Œë¦¬ì›Œë“¤</h2>
      <p id="popup-message"></p>
    </div>
  </div>

<div id="helpPopup" class="popup hidden">
  <div class="popup-content">
    <span id="help-close" style="float:right;cursor:pointer;font-size:20px;">Ã—</span>
    <h2>ê²Œì„ ê·œì¹™</h2>
    <div style="text-align:center;line-height:1.8;font-size:15px;">
      <div style="font-size:20px;font-weight:900;margin-bottom:8px;">ì†Œë¦¬ì›Œë“¤</div>
      <div>ì†Œë¦¬MADì™€ ê´€ë ¨ëœ ëª¨ë“  ë‹¨ì–´ê°€ ì œì‹œì–´ì…ë‹ˆë‹¤.</div>
      <div>í•˜ë£¨ì— ë¬¸ì œ 1ê°œ, ê¸°íšŒ 6ë²ˆ.</div>
      <div style="margin-top:8px;">ìƒ‰ì˜ ì˜ë¯¸</div>
      <div>ğŸŸ© ìœ„ì¹˜Â·ë‚±ì ëª¨ë‘ ì¼ì¹˜</div>
      <div>ğŸŸ¨ ë‹¨ì–´ ì•ˆì— ìˆì§€ë§Œ ìœ„ì¹˜ ë‹¤ë¦„</div>
      <div>â¬œ ë‹¨ì–´ì— ì—†ìŒ</div>
      <div style="font-size:12px;color:#888;margin-top:10px;">â€œì†Œë¦¬ì›Œë“¤â€ì€ ìì •ì— ê°±ì‹ ë©ë‹ˆë‹¤.</div>
    </div>
  </div>
</div>
  
  <script>

      // === ê·œì¹™ íŒì—… ===
  function openHelpPopup(){
    document.getElementById("helpPopup").classList.remove("hidden");
  }
  function closeHelpPopup(){
    document.getElementById("helpPopup").classList.add("hidden");
  }
  document.getElementById("help-close").onclick = closeHelpPopup;

  // ë‹¹ì¼ ì²« ì ‘ì† ì‹œ ê·œì¹™ íŒì—… ìë™ í‘œì‹œ
  const todayKey = "help-seen-" + new Date().toISOString().slice(0,10);
  if(!localStorage.getItem(todayKey)){
    setTimeout(openHelpPopup, 500);
    localStorage.setItem(todayKey,"true");
  }

    // === í…Œë§ˆ ===
    function loadTheme() {
      const t = localStorage.getItem('sori-wordle-theme') || 'light';
      document.body.className = t;
      document.getElementById('themeBtn').textContent =
        t === 'light' ? 'ğŸŒ™ ë‹¤í¬ ëª¨ë“œ' : 'â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ';
    }
    function toggleTheme() {
      const cur = document.body.className === 'light' ? 'dark' : 'light';
      document.body.className = cur;
      localStorage.setItem('sori-wordle-theme', cur);
      loadTheme();
    }
    loadTheme();

    // === í•œê¸€ ë¶„ë¦¬ ===
    const ì´ˆì„±=["ã„±","ã„²","ã„´","ã„·","ã„¸","ã„¹","ã…","ã…‚","ã…ƒ","ã……","ã…†","ã…‡","ã…ˆ","ã…‰","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    const ì¤‘ì„±=["ã…","ã…","ã…‘","ã…’","ã…“","ã…”","ã…•","ã…–","ã…—","ã…˜","ã…™","ã…š","ã…›","ã…œ","ã…","ã…","ã…Ÿ","ã… ","ã…¡","ã…¢","ã…£"];
    const ì¢…ì„±=["","ã„±","ã„²","ã„³","ã„´","ã„µ","ã„¶","ã„·","ã„¹","ã„º","ã„»","ã„¼","ã„½","ã„¾","ã„¿","ã…€","ã…","ã…‚","ã…„","ã……","ã…†","ã…‡","ã…ˆ","ã…Š","ã…‹","ã…Œ","ã…","ã…"];
    const ê¼¬ë“¤ì´ì¤‘ëª¨ìŒ={ "ã…˜":["ã…—","ã…"],"ã…™":["ã…—","ã…"],"ã…š":["ã…—","ã…£"],"ã…":["ã…œ","ã…“"],"ã…":["ã…œ","ã…”"],"ã…Ÿ":["ã…œ","ã…£"],"ã…¢":["ã…¡","ã…£"],"ã…’":["ã…‘","ã…£"],"ã…–":["ã…•","ã…£"] };
    const ê¼¬ë“¤ì´ì¤‘ë°›ì¹¨={ "ã„³":["ã„±","ã……"],"ã„µ":["ã„´","ã…ˆ"],"ã„¶":["ã„´","ã…"],"ã„º":["ã„¹","ã„±"],"ã„»":["ã„¹","ã…"],"ã„¼":["ã„¹","ã…‚"],"ã„½":["ã„¹","ã……"],"ã„¾":["ã„¹","ã…Œ"],"ã„¿":["ã„¹","ã…"],"ã…€":["ã„¹","ã…"],"ã…„":["ã…‚","ã……"] };
    const ê¼¬ë“¤ëœì†Œë¦¬ = {"ã„²":["ã„±","ã„±"], "ã„¸":["ã„·","ã„·"], "ã…ƒ":["ã…‚","ã…‚"], "ã…‰":["ã…ˆ","ã…ˆ"], "ã…†":["ã……","ã……"]
};

    function ë¶„ë¦¬(ch){
  const code=ch.charCodeAt(0)-0xAC00;
  if(code<0||code>11171) return [ch];

  const cho=Math.floor(code/588), jung=Math.floor((code-cho*588)/28), jong=code%28;
  let res=[];

  // ì´ˆì„± ì²˜ë¦¬: ëœì†Œë¦¬ë©´ ë¶„í•´
  const choChar=ì´ˆì„±[cho];
  if(ê¼¬ë“¤ëœì†Œë¦¬[choChar]) res.push(...ê¼¬ë“¤ëœì†Œë¦¬[choChar]);
  else res.push(choChar);

  // ì¤‘ì„± ì²˜ë¦¬: ì´ì¤‘ëª¨ìŒ ë¶„í•´
  const jungChar=ì¤‘ì„±[jung];
  if(ê¼¬ë“¤ì´ì¤‘ëª¨ìŒ[jungChar]) res.push(...ê¼¬ë“¤ì´ì¤‘ëª¨ìŒ[jungChar]);
  else res.push(jungChar);

  // ì¢…ì„± ì²˜ë¦¬: ì´ì¤‘ë°›ì¹¨/ëœì†Œë¦¬ ë¶„í•´
  if(jong!==0){
    const jongChar=ì¢…ì„±[jong];
    if(ê¼¬ë“¤ì´ì¤‘ë°›ì¹¨[jongChar]) res.push(...ê¼¬ë“¤ì´ì¤‘ë°›ì¹¨[jongChar]);
    else if(ê¼¬ë“¤ëœì†Œë¦¬[jongChar]) res.push(...ê¼¬ë“¤ëœì†Œë¦¬[jongChar]);  // ã„², ã…† ì²˜ë¦¬
    else res.push(jongChar);
  }

  return res;
}
    
// === ìœ íš¨ì„±(ìëª¨ ì‹œí€€ìŠ¤) ê²€ì‚¬ ìœ í‹¸ ===
const ëœì†Œë¦¬ìŒ   = {'ã„±ã„±':'ã„²','ã„·ã„·':'ã„¸','ã…‚ã…‚':'ã…ƒ','ã…ˆã…ˆ':'ã…‰','ã……ã……':'ã…†'};
const ëª¨ìŒí•©ì¹˜   = {'ã…—ã…':'ã…˜','ã…—ã…':'ã…™','ã…—ã…£':'ã…š','ã…œã…“':'ã…','ã…œã…”':'ã…','ã…œã…£':'ã…Ÿ','ã…¡ã…£':'ã…¢','ã…‘ã…£':'ã…’','ã…•ã…£':'ã…–'};
const ë°›ì¹¨í•©ì¹˜   = {'ã„±ã……':'ã„³','ã„´ã…ˆ':'ã„µ','ã„´ã…':'ã„¶','ã„¹ã„±':'ã„º','ã„¹ã…':'ã„»','ã„¹ã…‚':'ã„¼','ã„¹ã……':'ã„½','ã„¹ã…Œ':'ã„¾','ã„¹ã…':'ã„¿','ã„¹ã…':'ã…€','ã…‚ã……':'ã…„','ã„±ã„±':'ã„²','ã……ã……':'ã…†'};

function isì´ˆì„±(x){ return ì´ˆì„±.includes(x); }
function isì¤‘ì„±(x){ return ì¤‘ì„±.includes(x); }
function isì¢…ì„±(x){ return ì¢…ì„±.includes(x) && x !== ""; }

// ë‹¤ìŒ í† í°ë“¤ì´ ìƒˆ ìŒì ˆ ì‹œì‘ì´ ë  ìˆ˜ ìˆëŠ”ì§€(ì´ˆì„± ë˜ëŠ” ëœì†Œë¦¬ ìŒ)
function canStartSyllable(a,b){
  if (isì´ˆì„±(a)) return true;
  const pair = (a||'') + (b||'');
  return !!ëœì†Œë¦¬ìŒ[pair];
}

// ìëª¨ ë°°ì—´ì´ (ì´ˆì„±+ì¤‘ì„±(+ì¢…ì„±))^N í˜•íƒœì¸ì§€ ì—„ê²© ê²€ì¦
function isValidJamoSequence(seq){
  let i = 0, n = seq.length;
  while (i < n){
    // 1) ì´ˆì„± (ëœì†Œë¦¬ í—ˆìš©: ã„±ã„±â†’ã„² ë“±)
    let cho = seq[i++];
    const tensify = ëœì†Œë¦¬ìŒ[cho + (seq[i]||'')];
    if (tensify){ cho = tensify; i++; }
    if (!isì´ˆì„±(cho)) return false;

    // 2) ì¤‘ì„± (ë‹¨ëª¨ìŒ ë˜ëŠ” ì´ì¤‘ëª¨ìŒ: ã…—+ã…â†’ã…˜ ë“±)
    if (i >= n) return false;
    let jung1 = seq[i++], jung = jung1;
    const combV = ëª¨ìŒí•©ì¹˜[jung1 + (seq[i]||'')];
    if (combV){ jung = combV; i++; }
    if (!isì¤‘ì„±(jung)) return false;

    // 3) ì¢…ì„±(ì„ íƒ) â€” ìˆìœ¼ë©´ ì†Œë¹„, ì—†ìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‹¤ìŒ ìŒì ˆ
    if (i < n){
      // ì´ì¤‘ë°›ì¹¨ ìš°ì„  ì‹œë„ (ë‹¤ìŒì´ ëì´ê±°ë‚˜ ìƒˆ ìŒì ˆ ì‹œì‘ì´ì–´ì•¼ í•¨)
      const combF = ë°›ì¹¨í•©ì¹˜[seq[i] + (seq[i+1]||'')];
      if (combF){
        if (i+2 >= n || canStartSyllable(seq[i+2], seq[i+3])){
          i += 2; 
          continue;
        }
      }
      // ë‹¨ì¼ ë°›ì¹¨ ì‹œë„ (ì—­ì‹œ ë‹¤ìŒì´ ë/ìƒˆ ìŒì ˆ ì‹œì‘ì´ì–´ì•¼ í•¨)
      if (isì¢…ì„±(seq[i])){
        if (i+1 >= n || canStartSyllable(seq[i+1], seq[i+2])){
          i += 1;
        }
      }
    }
  }
  return i === n;
}

// í–‰ invalid í‘œì‹œ/í•´ì œ
function markInvalidRow(){
  const rowEls = document.getElementById("board").children[currentRow].children;
  for (const c of rowEls) c.classList.add("invalid");
}
function clearInvalidRow(){
  const rowEls = document.getElementById("board").children[currentRow].children;
  for (const c of rowEls) c.classList.remove("invalid");
}

  
// === ìœ íš¨ì„± ê²€ì‚¬ ===
function isValidWord(word) {
  // ëª¨ë“  ê¸€ìê°€ ì™„ì„±í˜• í•œê¸€(ê°€~í£)ì¸ì§€ í™•ì¸
  return /^[ê°€-í£]+$/.test(word);
}

// ë§¤ì¼ ë™ì¼í•œ "ëœë¤" ë‹¨ì–´ë¥¼ ë½‘ê¸° ìœ„í•œ í•¨ìˆ˜
function seededRandom(seed) {
  const x = Math.sin(seed) * 10000;
  return x - Math.floor(x);
}

function pickDailyWord(pool) {
  const start = new Date("2025-01-01T00:00:00+09:00"); // ê¸°ì¤€ì¼ í•œêµ­ì‹œê°„
  const today = getKSTDate(); // ì´ë¯¸ ìˆëŠ” í•œêµ­ì‹œê°„ í•¨ìˆ˜ ì‚¬ìš©
  const days = Math.floor((today - start) / (1000*60*60*24));

  // daysë¥¼ ì‹œë“œë¡œ ì‚¼ì•„ ë§¤ì¼ ëœë¤ ì¸ë±ìŠ¤ ìƒì„±
  const idx = Math.floor(seededRandom(days) * pool.length);
  return pool[idx];
}
    
// === ë°ì´í„° ===
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4cPYQbKRxFQsTv7byzVnKwN6WdlRECyFvSkn39mcnNIywqTZ9W71P8nzw0SI8oEP_4QzBFaJbNQyN/pub?output=csv";
let ë‹¨ì–´ëª©ë¡ = [];
const fallbackWords = ["ë‚ ì™ˆ","ì‚¬ì´í‚¤ë¼", "ëŒ€ì •ë ¹", "ë Œë”", "ìš°ì‚¬í…Œì´"];

// ğŸ”´ ì „ì—­ ìƒíƒœ (ëˆ„ë½ë˜ì–´ ìˆë˜ ê²ƒë“¤)
let ì •ë‹µ, ì •ë‹µë‚±ì;
const maxRows = 6;
let currentRow = 0, currentCol = 0;
let gameOver = false;
let currentGuess = [];
let lastTries = null;   // âœ… ì¶”ê°€: ê³µìœ ìš© ì‹œë„ íšŸìˆ˜ ì €ì¥

// CSV 1ì—´ë§Œ ì‚¬ìš© + BOM/CRLF ì •ë¦¬
function parseCSVFirstColumn(csvText){
  const clean = csvText.replace(/^\uFEFF/, "");
  const lines = clean.split(/\r?\n/);
  const firstCol = lines
    .map(line => (line.split(",")[0] || "").trim())
    .filter(Boolean);
  // ìˆœìˆ˜ í•œê¸€ë§Œ
  const onlyHangul = firstCol.filter(w => /^[ê°€-í£]+$/.test(w));
  return onlyHangul;
}

// ì‹œíŠ¸ ë¡œë”© (ì¤‘ë³µ í˜¸ì¶œ ê¸ˆì§€)
function loadWords(){
  return fetch(sheetUrl + "&t=" + Date.now(), { cache: "no-store" })
    .then(r => {
      if(!r.ok) throw new Error("HTTP " + r.status);
      return r.text();
    })
    .then(csv => {
      // ë””ë²„ê·¸ ë¡œê·¸ (ê°œë°œìë„êµ¬ ì½˜ì†”ì—ì„œ í™•ì¸)
      console.log("[CSV raw len]", csv.length);
      console.log("[CSV preview]", csv.slice(0, 200));

      const parsed = parseCSVFirstColumn(csv);
      console.log("[Parsed count]", parsed.length, parsed.slice(0, 10));

      if (parsed.length === 0) throw new Error("ë¹ˆ ëª©ë¡");
      return parsed;
    });
}

// âœ… í˜¸ì¶œë¶€: ë°˜ë“œì‹œ í•œ ë²ˆë§Œ!
loadWords()
  .then(list => { ë‹¨ì–´ëª©ë¡ = list; initGame(); })
  .catch(err => {
    console.error("ë‹¨ì–´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
    ë‹¨ì–´ëª©ë¡ = fallbackWords;
    showPopup("ë‹¨ì–´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‹œíŠ¸ë¥¼ 'ì›¹ì— ê²Œì‹œ'í–ˆëŠ”ì§€ì™€ Aì—´ì— í•œê¸€ë§Œ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
    initGame();
  });

    // === í†µê³„ ===
    function updateStats(win, tries){
      const stats=JSON.parse(localStorage.getItem("sori-stats")||'{"played":0,"wins":0,"dist":[0,0,0,0,0,0]}');
      stats.played++;
      if(win){ stats.wins++; stats.dist[tries-1]++; }
      localStorage.setItem("sori-stats", JSON.stringify(stats));
    }
    function getStats(){
      return JSON.parse(localStorage.getItem("sori-stats")||'{"played":0,"wins":0,"dist":[0,0,0,0,0,0]}');
    }

    // í•œêµ­ ì‹œê°„(KST) ê¸°ì¤€ ë‚ ì§œ ë°˜í™˜
function getKSTDate() {
  // í˜„ì¬ UTC ì‹œê°„ + í•œêµ­ ì‹œê°„(UTC+9) ë³´ì •
  const now = new Date();
  const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
  return new Date(utc + (9 * 60 * 60000));
}
    
// === í¼ì¦ ë²ˆí˜¸/ì •ë‹µ ìºì‹œ (ì˜¤ëŠ˜ ê³ ì •) ===
function getPuzzleNo() {
  const start = new Date("2025-01-01T00:00:00+09:00"); // ê¸°ì¤€ì¼ KST
  const today = getKSTDate(); // ìœ„ í•¨ìˆ˜ ì‚¬ìš©
  return Math.floor((today - start) / (1000 * 60 * 60 * 24));
}
function saveTodayAnswer(answer) {
  localStorage.setItem("sori-answer-" + getPuzzleNo(), String(answer));
}
function loadTodayAnswer() {
  return localStorage.getItem("sori-answer-" + getPuzzleNo());
}
    
    // === ê²Œì„ ì´ˆê¸°í™” ===

function initGame(){
  // 1) í’€ ì¤€ë¹„(ë„¤ ê¸°ì¡´ ë¡œì§ ìœ ì§€)
  const pool = (Array.isArray(ë‹¨ì–´ëª©ë¡) && ë‹¨ì–´ëª©ë¡.length > 0) ? ë‹¨ì–´ëª©ë¡ : fallbackWords;

  // 2) ì˜¤ëŠ˜ ì •ë‹µ: ìºì‹œì— ìˆìœ¼ë©´ ê·¸ê±¸ë¡œ ê³ ì •, ì—†ìœ¼ë©´ ì„ íƒ í›„ ì €ì¥
  const cached = loadTodayAnswer();
  if (cached && typeof cached === "string" && cached.trim()) {
    ì •ë‹µ = cached.trim();
  } else {
    ì •ë‹µ = pickDailyWord(pool) || (fallbackWords[0] || "ê°€");
    saveTodayAnswer(ì •ë‹µ);
  }

  // 3) ë‚±ì ë¶„í•´ (ë„¤ ê¸°ì¡´ ë¡œì§)
  ì •ë‹µë‚±ì = [];
  for (let ch of ì •ë‹µ) ì •ë‹µë‚±ì.push(...ë¶„ë¦¬(ch));

  // ì•ˆì „ì¥ì¹˜: ë¶„í•´ ì‹¤íŒ¨ ì‹œ í’€ ì²« í•­ëª©ìœ¼ë¡œ ëŒ€ì²´í•˜ê³  ìºì‹œë„ ê°±ì‹ 
  if (!ì •ë‹µë‚±ì.length) {
    ì •ë‹µ = pool[0] || (fallbackWords[0] || "ê°€");
    ì •ë‹µë‚±ì = [];
    for (let ch of ì •ë‹µ) ì •ë‹µë‚±ì.push(...ë¶„ë¦¬(ch));
    saveTodayAnswer(ì •ë‹µ);
  }

  // 4) ë³´ë“œ ë Œë” (ë„¤ ê¸°ì¡´ ë¡œì§)
  const board = document.getElementById("board");
  board.innerHTML = "";
  for (let r=0; r<maxRows; r++){
    const row = document.createElement("div");
    row.className = "row";
    for (let c=0; c<ì •ë‹µë‚±ì.length; c++){
      const cell = document.createElement("div");
      cell.className = "cell";
      row.appendChild(cell);
    }
    board.appendChild(row);
  }

  buildKeyboard();
  console.log("[INIT] puzzleNo=", getPuzzleNo(), "answer=", ì •ë‹µ);
}
    // === í‚¤ë³´ë“œ ===
    function buildKeyboard(){
      const rows=[["ã…‚","ã…ˆ","ã„·","ã„±","ã……","ã…›","ã…•","ã…‘","ã…","ã…”"],
                  ["ã…","ã„´","ã…‡","ã„¹","ã…","ã…—","ã…“","ã…","ã…£"],
                  ["ì…ë ¥","ã…‹","ã…Œ","ã…Š","ã…","ã… ","ã…œ","ã…¡","ì‚­ì œ"]];
      const keyDiv=document.getElementById("keyboard"); keyDiv.innerHTML="";
      rows.forEach(row=>{
        const rowDiv=document.createElement("div"); rowDiv.className="key-row";
        row.forEach(k=>{
          const keyBtn=document.createElement("div");
          keyBtn.className="key"; keyBtn.textContent=k;
          if(k==="ì…ë ¥"||k==="ì‚­ì œ") keyBtn.classList.add("wide");
          keyBtn.onclick=()=>handleKey(k);
          rowDiv.appendChild(keyBtn);
        });
        keyDiv.appendChild(rowDiv);
      });
    }

// === í‚¤ ì…ë ¥ ===
    
function handleKey(k){
  if (gameOver) return;

  if (k === "ì…ë ¥") {
    submitGuess();                 // âœ… í•­ìƒ ì‹œë„
    return;
  }

  if (k === "ì‚­ì œ") {
    if (currentCol > 0) {
      currentCol--;
      currentGuess.pop();
      const cell = document.getElementById("board").children[currentRow].children[currentCol];
      cell.textContent = "";
      clearInvalidRow();           // í¸ì§‘í•˜ë©´ ê²½ê³  í•´ì œ
    }
    return;
  }

  // ì¼ë°˜ ìëª¨ ì…ë ¥
  if (currentCol < ì •ë‹µë‚±ì.length) {
    currentGuess.push(k);
    document.getElementById("board").children[currentRow].children[currentCol].textContent = k;
    currentCol++;
    clearInvalidRow();             // í¸ì§‘í•˜ë©´ ê²½ê³  í•´ì œ
  }
}

// === ë‚±ì ë°°ì—´ì„ í•©ì„±í•´ì„œ ì™„ì„±í˜• í•œê¸€ ë‹¨ì–´ë¡œ ë§Œë“œëŠ” í•¨ìˆ˜ ===
function combineGuessToWord(guess){
  let combined = "";
  for (let i = 0; i < guess.length; ){
    let choChar = guess[i];

    // ëœì†Œë¦¬ ì²˜ë¦¬
    if (i+1 < guess.length) {
      const pair = choChar + guess[i+1];
      if (pair === "ã„±ã„±") { choChar = "ã„²"; i++; }
      else if (pair === "ã„·ã„·") { choChar = "ã„¸"; i++; }
      else if (pair === "ã…‚ã…‚") { choChar = "ã…ƒ"; i++; }
      else if (pair === "ã…ˆã…ˆ") { choChar = "ã…‰"; i++; }
      else if (pair === "ã……ã……") { choChar = "ã…†"; i++; }
    }

    let cho = ì´ˆì„±.indexOf(choChar);
    if (cho < 0) { i++; continue; }

    let jung = ì¤‘ì„±.indexOf(guess[i+1]||"");
    if (jung < 0) { i++; continue; }

    let jong = 0;
    if (i+2 < guess.length) {
      let idx = ì¢…ì„±.indexOf(guess[i+2]);
      if (idx > 0) { jong = idx; i++; }
    }

    const syllableCode = 0xAC00 + cho*588 + jung*28 + jong;
    combined += String.fromCharCode(syllableCode);
    i += (jong ? 3 : 2);
  }
  return combined;
}
    
// === ì œì¶œ ===
function submitGuess() {
  const guess = [...currentGuess];

  if (guess.length !== ì •ë‹µë‚±ì.length) return;

  // --- ìœ íš¨ì„± ê²€ì‚¬ ---
  if (!isValidJamoSequence(guess)) {
    markInvalidRow(); // ë¹¨ê°„ìƒ‰ íš¨ê³¼
    return;
  }

  const row = document.getElementById("board").children[currentRow].children;

  // --- íŒì • ì¤€ë¹„ ---
  const freq = {};
  for (let i=0; i<ì •ë‹µë‚±ì.length; i++) {
    freq[ì •ë‹µë‚±ì[i]] = (freq[ì •ë‹µë‚±ì[i]] || 0) + 1;
  }

  const result = new Array(ì •ë‹µë‚±ì.length).fill("absent");
  for (let i=0; i<ì •ë‹µë‚±ì.length; i++) {
    if (guess[i] === ì •ë‹µë‚±ì[i]) {
      result[i] = "correct";
      freq[guess[i]]--;
    }
  }
  for (let i=0; i<ì •ë‹µë‚±ì.length; i++) {
    if (result[i] === "correct") continue;
    if (freq[guess[i]] > 0) {
      result[i] = "present";
      freq[guess[i]]--;
    }
  }

  // --- ì¹¸ ìƒ‰ì¹  + í‚¤ë³´ë“œ ê°±ì‹  ---
  for (let i=0; i<ì •ë‹µë‚±ì.length; i++) {
    row[i].textContent = guess[i];
    row[i].classList.add(result[i]);
    updateKeyboard(guess[i], result[i]);
  }

  // --- ì •ë‹µ ë§ì¶˜ ê²½ìš° ---
  if (guess.join("") === ì •ë‹µë‚±ì.join("")) {
    gameOver = true;
    const tries = currentRow+1;
    lastTries = currentRow+1;
    updateStats(true, tries);
    setTimeout(() => showPopup("ì •ë‹µ! ğŸ‰ ("+tries+"/6)"), 600);
    document.getElementById("shareBtn").style.display = "inline-block";
    return;
  }

  // --- ë‹¤ìŒ ì¤„ ì´ë™ ---
  currentRow++;
  currentCol = 0;
  currentGuess = [];

  // --- ì‹¤íŒ¨ ì²˜ë¦¬ ---
  if (currentRow >= maxRows && !gameOver) {
    gameOver = true;
    lastTries = "X";
    updateStats(false,0);
    setTimeout(() => showPopup("ì‹¤íŒ¨! ì •ë‹µì€ "+ì •ë‹µ), 600);
    document.getElementById("shareBtn").style.display = "inline-block";
  }
}
    // === í‚¤ë³´ë“œ ìƒ‰ ì—…ë°ì´íŠ¸ ===
    function updateKeyboard(letter,state){
      document.querySelectorAll(".key").forEach(k=>{
        if(k.textContent===letter){
          if(state==="correct") k.className="key correct";
          else if(state==="present" && !k.classList.contains("correct")) k.className="key present";
          else if(state==="absent" && !k.classList.contains("correct") && !k.classList.contains("present")) k.className="key absent";
        }
      });
    }

    // === íŒì—… ===
    function showPopup(msg){ document.getElementById("popup-message").textContent=msg; document.getElementById("popup").classList.remove("hidden"); }
    document.getElementById("popup-close").onclick=()=>{ document.getElementById("popup").classList.add("hidden"); };

    // === ê³µìœ  ===
function shareResult() {
  const text = buildShareText();

  // âœ… í•­ìƒ í´ë¦½ë³´ë“œ ë³µì‚¬ë§Œ ì‹œë„
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(text)
      .then(() => alert("ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!"))
      .catch(err => {
        console.error("Clipboard API ì‹¤íŒ¨:", err);
        tryClipboardCopy(text); // í´ë°±
      });
  } else {
    // âœ… execCommand í´ë°±
    tryClipboardCopy(text);
  }
}
// âœ… ìµœì¢… í´ë°±: ìˆ¨ì€ textareaë¥¼ ë§Œë“¤ì–´ execCommand('copy') ì‚¬ìš©

    function tryClipboardCopy(text){
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.setAttribute("readonly", "");
  ta.style.position = "fixed";
  ta.style.top = "-1000px";
  document.body.appendChild(ta);

  // â–¼ ë°˜ë“œì‹œ ì„ íƒí•´ì¤˜ì•¼ ë³µì‚¬ê°€ ëœë‹¤
  ta.select();
  ta.setSelectionRange(0, 999999);

  let ok = false;
  try {
    ok = document.execCommand("copy");
  } catch(e) { ok = false; }

  document.body.removeChild(ta);
  alert(ok ? "ê²°ê³¼ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!" : "ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì €/HTTPS í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”.");
}

// âœ… ê³µìœ  í…ìŠ¤íŠ¸ ìƒì„± (N/6 ë˜ëŠ” X/6 + ë¸”ë¡ íŒ¨í„´)
function buildShareText(){
  const tries = (lastTries===null) ? "X" : lastTries;

  // âœ… ì˜¤ëŠ˜ ë‚ ì§œ (YYYY-MM-DD)
  const today = new Date();
  const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,"0");
  const dd = String(today.getDate()).padStart(2,"0");
  const dateStr = `${yyyy}-${mm}-${dd}`;

  // âœ… ì²« ì¤„ì— ë‚ ì§œ í¬í•¨
  let output = `#ì†Œë¦¬ì›Œë“¤ ${tries}/6 (${dateStr})\n`;

  // ì„±ê³µì´ë©´ lastTries ë§Œí¼ ì¤„ ì¶œë ¥, ì‹¤íŒ¨ë©´ 6ì¤„
  const rowsToPrint = (typeof lastTries === "number") ? lastTries : maxRows;

  for (let r=0; r<rowsToPrint; r++){
    // âœ… ë§ˆì§€ë§‰ ì¤„ì´ê³  ì„±ê³µí•œ ê²½ìš° â†’ ì „ë¶€ ì´ˆë¡ìœ¼ë¡œ ê°•ì œ
    if (typeof lastTries === "number" && r === rowsToPrint-1){
      output += "ğŸŸ©".repeat(ì •ë‹µë‚±ì.length) + "\n";
      continue;
    }

    const row = document.getElementById("board").children[r].children;
    for (let c=0; c<ì •ë‹µë‚±ì.length; c++){
      if (row[c].classList.contains("correct")) output += "ğŸŸ©";
      else if (row[c].classList.contains("present")) output += "ğŸŸ¨";
      else output += "â¬œ";
    }
    output += "\n";
  }

  // âœ… ë§ˆì§€ë§‰ì— ì‚¬ì´íŠ¸ ì£¼ì†Œ ì¶”ê°€
  output += "\nhttps://sori-wordle.com";

  return output;
}
    // === í†µê³„ ë³´ê¸° ===
    document.getElementById("statsBtn").onclick=()=>{
      const s=getStats();
      let msg=`í”Œë ˆì´: ${s.played}\nìŠ¹ë¦¬: ${s.wins}\nìŠ¹ë¥ : ${s.played?Math.round(s.wins/s.played*100):0}%\n\nì‹œë„ ë¶„í¬:\n`;
      s.dist.forEach((v,i)=>{ msg+=`${i+1}íšŒ: ${v}\n`; });
      showPopup(msg);
    };
  </script>
</body>
</html>
